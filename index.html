<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chimpanzee Social Behavior Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f9;
  padding: 20px;
}

h1 { margin-bottom: 20px; }

.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}

.card {
  background: white;
  padding: 18px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.card p {
  font-size: 26px;
  font-weight: bold;
  margin: 5px 0 0;
}

.charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
  gap: 25px;
  margin-bottom: 40px;
}

.chart-box {
  background: white;
  padding: 20px;
  border-radius: 10px;
}

table {
  width: 100%;
  background: white;
  border-collapse: collapse;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #eee;
  font-size: 13px;
}

th { background: #f0f2f5; }

.pagination {
  margin-top: 15px;
}

button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #007bff;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Chimpanzee Social Behavior Dashboard</h1>

<!-- KPI CARDS -->
<div class="cards">
  <div class="card"><small>Sessions</small><p id="sessions">0</p></div>
  <div class="card"><small>Presence Records</small><p id="presence">0</p></div>
  <div class="card"><small>Grooming Events</small><p id="grooming">0</p></div>
  <div class="card"><small>Contact Events</small><p id="contact">0</p></div>
  <div class="card"><small>Arms Reach</small><p id="arms">0</p></div>
  <div class="card"><small>Co-feeding</small><p id="feeding">0</p></div>
</div>

<!-- CHARTS -->
<div class="charts">
  <div class="chart-box"><canvas id="behaviorBar"></canvas></div>
  <div class="chart-box"><canvas id="behaviorPie"></canvas></div>
  <div class="chart-box"><canvas id="sessionLine"></canvas></div>
  <div class="chart-box"><canvas id="topPartners"></canvas></div>
</div>

<!-- TABLE -->
<h2>Raw Observation Data</h2>
<table>
<thead>
<tr>
  <th>Session</th><th>Date</th><th>Chimp</th><th>Present</th>
  <th>Grooming</th><th>Contact</th><th>Arms Reach</th><th>Co-feeding</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div class="pagination">
  <button onclick="prevPage()">Prev</button>
  <button onclick="nextPage()">Next</button>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSOFeFnJwXh8V9BQtaeMa6nWk76v6cZ229rLxTUzzWGqhrmurbbDpbu1Bodz2LCNE_AtkPs07wWOOmQ/pub?gid=1298553947&single=true&output=csv";

let rows = [];
let page = 1;
const perPage = 12;

fetch(SHEET_URL)
.then(res => res.text())
.then(csv => {
  rows = csv.split("\n").slice(1).map(r => r.split(","));
  analyze();
  renderTable();
});

function splitPartners(cell) {
  if (!cell) return [];
  return cell.split(/[;,]/).map(x => x.trim()).filter(Boolean);
}

function analyze() {
  let sessions = new Set();
  let presence = 0, grooming = 0, contact = 0, arms = 0, feeding = 0;
  let sessionCounts = {};
  let partnerMap = {};

  rows.forEach(r => {
    const session = r[0];
    const presentVal = r[3];
    sessions.add(session);

    if (presentVal !== "Yes") return;
    presence++;

    if (r[4] === "Yes") grooming++;
    if (r[7] === "Yes") contact++;
    if (r[10] === "Yes") arms++;
    if (r[11] === "Yes") feeding++;

    sessionCounts[session] = (sessionCounts[session] || 0) +
      (r[4] === "Yes") + (r[7] === "Yes") + (r[10] === "Yes") + (r[11] === "Yes");

    [...splitPartners(r[6]), ...splitPartners(r[8]), ...splitPartners(r[9]), ...splitPartners(r[12])]
      .forEach(p => partnerMap[p] = (partnerMap[p] || 0) + 1);
  });

  document.getElementById("sessions").textContent = sessions.size;
  document.getElementById("presence").textContent = presence;
  document.getElementById("grooming").textContent = grooming;
  document.getElementById("contact").textContent = contact;
  document.getElementById("arms").textContent = arms;
  document.getElementById("feeding").textContent = feeding;

  createCharts(grooming, contact, arms, feeding, sessionCounts, partnerMap);
}

function createCharts(g, c, a, f, sessions, partners) {
  new Chart(behaviorBar, {
    type: "bar",
    data: { labels: ["Grooming","Contact","Arms","Feeding"],
      datasets: [{ data: [g,c,a,f] }] }
  });

  new Chart(behaviorPie, {
    type: "pie",
    data: { labels: ["Grooming","Contact","Arms","Feeding"],
      datasets: [{ data: [g,c,a,f] }] }
  });

  new Chart(sessionLine, {
    type: "line",
    data: {
      labels: Object.keys(sessions),
      datasets: [{ label: "Behaviors per Session", data: Object.values(sessions) }]
    }
  });

  const sorted = Object.entries(partners).sort((a,b)=>b[1]-a[1]).slice(0,8);
  new Chart(topPartners, {
    type: "bar",
    data: {
      labels: sorted.map(x=>x[0]),
      datasets: [{ label:"Interactions", data: sorted.map(x=>x[1]) }]
    }
  });
}

function renderTable() {
  tableBody.innerHTML = "";
  rows.slice((page-1)*perPage, page*perPage).forEach(r => {
    tableBody.innerHTML += `
      <tr>
        <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>
        <td>${r[3]}</td><td>${r[4]}</td>
        <td>${r[7]}</td><td>${r[10]}</td><td>${r[11]}</td>
      </tr>`;
  });
}

function nextPage(){ page++; renderTable(); }
function prevPage(){ if(page>1){ page--; renderTable(); } }
</script>

</body>
</html>
